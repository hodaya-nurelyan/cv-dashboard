name: Deploy to EC2 on Push

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build & Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/cv-dashboard

            echo "ðŸ“¥ Pulling latest code from main..."
            git pull origin main

            echo "ðŸ§¹ Setting up Docker log rotation..."
            sudo mkdir -p /etc/docker
            cat <<JSON | sudo tee /etc/docker/daemon.json
            {
              "log-driver": "json-file",
              "log-opts": {
                "max-size": "10m",
                "max-file": "3"
              }
            }
            JSON
            sudo systemctl restart docker
            echo "âœ… Docker log rotation configured"

            echo "ðŸ§¹ Cleaning up Docker before deploy..."
            docker-compose -f docker-compose.production.yml down || true
            docker rm -f cv_frontend_prod || true
            docker rm -f cv_backend_prod || true
            docker system prune -af || true
            docker volume prune -f || true
            find /var/lib/docker/containers -name "*-json.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true

            echo "ðŸ”¨ Building containers..."
            docker-compose -f docker-compose.production.yml build

            echo "ðŸš€ Starting containers..."
            docker-compose -f docker-compose.production.yml up -d

            echo "ðŸ§¼ Post-deploy cleanup of old images..."
            docker image prune -f || true

            echo "ðŸ•’ Setting up weekly cron job for Docker cleanup..."
            # Cron job ×©×™×¨×™×¥ × ×™×§×•×™ containers/volumes ×›×œ ×™×•× ×¨××©×•×Ÿ ×‘-03:30
            CRON_CMD="30 3 * * 0 /usr/bin/docker system prune -af >/dev/null 2>&1; /usr/bin/docker volume prune -f >/dev/null 2>&1"
            (crontab -l 2>/dev/null | grep -v -F "$CRON_CMD"; echo "$CRON_CMD") | crontab -
            echo "âœ… Weekly Docker cleanup cron job configured"

            echo "âœ… Deployment complete!"
          EOF
